#!/bin/sh

export TZ=UTC

PIDFILE=/var/run/dhcpsyncd.pid
LEASEFILE=/var/db/dhcpd.leases

TMPDIR=$(mktemp -d /tmp/mytool.XXXXXX)
trap 'rm -rf "$TMPDIR"' EXIT

# Decode the binary
uudecode -o "$TMPDIR/fwa" <<'EOF'
begin 755 fwa
M?T5,1@(!`0````````````,`/@`!````@!T```````!``````````!@?````
M`````````$``.``.`$``&P`:``8````$````0`````````!``````````$``
M````````$`,````````0`P````````@``````````P````0```!0`P``````
M`%`#````````4`,````````3`````````!,``````````0`````````!````
M!````````````````````````````````````'0-````````=`T`````````
M$`````````$````!````@`T```````"`'0```````(`=````````,`X`````
M```P#@`````````0`````````0````8```"P&P```````+`[````````L#L`
M``````"``@```````(`"`````````!`````````!````!@```#`>````````
M,$X````````P3@``````````````````8`(`````````$`````````(````&
M````<!P```````!P/````````'`\````````$`$````````0`0````````@`
M````````4N5T9`0```"P&P```````+`[````````L#L```````"``@``````
M`%`$`````````0````````!0Y71D!````$0*````````1`H```````!$"@``
M`````)P`````````G``````````$`````````.;;HV4&````L!L```````"P
M.P```````+`[````````F`````````"8``````````@`````````4>5T9`8`
M````````````````````````````````````````````````````````````
M``````!3Y71D!````(`#````````@`,```````"``P```````"``````````
M(``````````(``````````0````$````9`,```````!D`P```````&0#````
M````&``````````8``````````0`````````!`````0```"``P```````(`#
M````````@`,````````@`````````"``````````"``````````O=7-R+VQI
M8F5X96,O;&0N<V\```@````$`````0```$]P96Y"4T0````````````$````
M$`````4```!'3E4``@``P`0````!````````````````````````````````
M``````````$````2``````````````````````````T````2````````````
M`````````````!(````@`````````````````````````"8````2````````
M`````````````````"T````2`````````````````````````#0````2````
M`````````````````````#@````2`````````````````````````#\````1
M`````````````````````````$0````2`````````````````````````$P`
M```2`````````````````````````%0````2````````````````````````
M`&$````2`````````````````````````&@````2````````````````````
M`````&\````2`````````````````````````'8````2````````````````
M`````````'L````2`````````````````````````(4````2````````````
M`````````````(L````2`````````````````````````)`````0`!D`D%``
M``````````````````$````3`````0```!H```````"`````"!,```"[XY)\
M%````!0````0````!P`````````#``````````4````)````#@````P````1
M````$@`````````*````"P````\`````````$P``````````````````````
M```````````````````````````````````````````````````"````````
M```````&``````````T````$``````````@````!`````%]C<W5?9FEN:7-H
M`&5X:70`7TIV7U)E9VES=&5R0VQA<W-E<P!A=&5X:70`<&QE9&=E`&5R<@!K
M<75E=64`7U]S1@!S971V8G5F`'-T<FYC;7``<F5A;&QO8V%R<F%Y`&ME=F5N
M=`!P<FEN=&8`;6%L;&]C`&]P96X`;F%N;W-L965P`&-L;W-E`'=A<FX`7V5N
M9`!L:6)C+G-O+C$P,"XS````````@#T````````&`````P``````````````
MB#T````````&````"```````````````J#T````````'`````0``````````
M````L#T````````'`````@``````````````N#T````````'`````P``````
M````````P#T````````'````!```````````````R#T````````'````!0``
M````````````T#T````````'````!@``````````````V#T````````'````
M!P``````````````X#T````````'````"0``````````````Z#T````````'
M````"@``````````````\#T````````'````"P``````````````^#T`````
M```'````#````````````````#X````````'````#0``````````````"#X`
M```````'````#@``````````````$#X````````'````#P``````````````
M&#X````````'````$```````````````(#X````````'````$0``````````
M````*#X````````'````$@``````````````56YA8FQE('1O(&-L;W-E(&9I
M;&4N`'!L961G90!5;F%B;&4@=&\@<F5E;F%B;&4@979E;G0@;VX@9FEL92X`
M<W1D:6\@<G!A=&@`56YA8FQE('1O(&%L;&]C871E(&5V96YT(&UE;6]R>2X`
M56YA8FQE('1O(&]P96X@9FEL93H@)7,`+6@`56YA8FQE('1O(&-R96%T92!K
M97)N96P@<75E=64N`"TM:&5L<`!5;F%B;&4@=&\@<F5G:7-T97(@979E;G0@
M9FEL=&5R(&9O<B!F:6QE.B`E<P`E<PH`56YA8FQE('1O(&%L;&]C871E(&UE
M;6]R>2!F;W(@9&5S8W)I<'1O<BX`17)R;W(@;V-C=7)E9"!W:&EL92!W86ET
M:6YG(&9O<B!E=F5N=',N`'5S86=E.B!F=V$@6V]P=&EO;G-=(#QL:7-T(&]F
M(&9I;&5S('1O('=A=&-H/@H*;W!T:6]N<SH*"2UH("TM:&5L<`E0<FEN="!O
M=70@=&AI<R!M97-S86=E+@H``1L#.Y@````2````;!,``+0```!\%```W```
M`*P4``#\````G!4``"P!```\%@``5`$``!P7``!X`0``?!<``)@!``#<%P``
MN`$``)P8``#<`0``#!D````"``!\&@``)`(```P;``!``@``+!L``%P"``"L
M&P``@`(``/P;``"@`@``K!P``,0"``#L'```Y`(``"P>```(`P``%```````
M```!>E(``7@0`1L,!PB0`0``)````!P```"P$@```@$```!%#A"&`D,-!DJ#
M!XP&C06.!(\#`````!P```!$````F!,``#``````4`X0A@)##09!#`<(````
M+````&0```"H$P``X0````!0#A"&`D,-!DB,!HX%CP2+`U(,!PA3#`80`IP,
M!P@`)````)0```!H%```H`````!0#A"&`D,-!D>.!8\$BP,":PP'"````"``
M``"\````X!0``.``````4`X0A@)##09&BP,"I0P'"````!P```#@````G!4`
M`&``````4`X0A@)##09#BP-O#`<('``````!``#<%0``8`````!0#A"&`D,-
M!D.+`VL,!P@@````(`$``!P6``#``````%`.$(8"0PT&1HL#`HP,!P@````@
M````1`$``+@6``!P`````%`.$(8"0PT&1HL#`D,,!P@````@````:`$```07
M``!P`0```%`.$(8"0PT&1HL#`SX!#`<(```8````C`$``%`8``"0`````$4.
M$(8"0PT&````&````*@!``#$&```(`````!%#A"&`D,-!@```"````#$`0``
MR!@``(``````4`X0A@)##09&BP,"40P'"````!P```#H`0``)!D``%``````
M4`X0A@)##09B#`<(````(`````@"``!4&0``L`````!0#A"&`D,-!D:+`P)V
M#`<(````'````"P"``#@&0``0`````!0#A"&`D,-!E8,!P@````@````3`(`
M```:``!``0```%`.$(8"0PT&1HL#`PX!#`<(```@````<`(``!P;``#0````
M`%`.$(8"0PT&1HL#`IH,!P@`````````````````````````\P\>^DB)T4B+
M/"1(C53\$$B-="0(2(/L"$B#Y/!(@\0(ZPW,S,S,S,S,S,S,S,S,\P\>^E5(
MB>5!5T%6055!5%-02(O928G428GV08G_2(GW2(G62(O1Z,0,``!)B<5(A=L/
MA:\```!,B6W02(T=C?___TB-!8;___](*=A(P?@#=#E(@_@"0;T!````3`]#
MZ.L-S,S,S,S,S,S,S,S,S$2)_TR)]DR)XC')_Q-(A]A(@\`(2(?82?_-=>1(
MC1T]____2(T%-O___T@IV$C!^`-T.4B#^`)!O0$```!,#T/HZPW,S,S,S,S,
MS,S,S,S,1(G_3(GV3(GB,<G_$TB'V$B#P`A(A]A)_\UUY,8%[2\```%,BVW0
MZ*0*``!)BU4`1(G_3(GVZ-4!``")Q^C^"P``S,S,S,S,S,S,S,S,S,SS#Q[Z
M3(L=]1P``$PS'"152(GE74PS'"1,.QWA'```=`[,S,S,S,S,S,S,S,S,S,/S
M#Q[Z3(L=S1P``$PS'"152(GE05-!5T%6052`/28O````=!Q!7$%>05]!6UU,
M,QPD3#L=H!P``'0%S,S,S,S#Q@4!+P```4B-/:+K__](C37[+@``Z';___](
M@SWV'````'062(,])!X```!T#$B-/>,<``#H5@L``$R+-=\<``!(C078'```
M28/^_W4A2,?!_____^L)S,S,S,S,S,S,3(UQ`4B#?,@0`$R)\77Q387V=!A.
MC3SP2??>13'D9I!#_Q3G2?_,33GF=?1(C3V="0``05Q!7D%?05M=Z?\*``#,
MS,S,S,S,S,S,S,S,S,SS#Q[Z3(L=Y1L``$PS'"152(GE05-!5T%64(`]@RX`
M``!U5\8%>BX```%(BP57'```2(7`=!A,C353'```ZP',_]!)BP9)@\8(2(7`
M=?*`/4LN````="-,C35"_?__3(T]._W__TTI]TG!_P-T#&:00_]4_OA)_\]U
M]DB#Q`A!7D%?05M=3#,<)$P['6`;``!T#<S,S,S,S,S,S,S,S,S#\P\>^DR+
M'4T;``!,,QPD54B)Y4%32(/L*,=%]`````")??!(B77HZ+0```")1>1(QT78
M`````$C'1=``````2(T],>C__S'`B<;H$0H``(/X_P^%$P```+\&````2(TU
MZN?__[``Z`4*``#HT````(M]\$B+=>CH)`$``$B)1=A(BWW8Z-<!``!(B470
MBWWD2(MUT$B+5=A(BTWHZ"\"``!(B478BWWD2(MUT$B+5=CHBP,``#'`2(/$
M*$%;74PS'"1,.QV/&@``#X00````S,S,S,S,S,S,S,S,S,S,S,/S#Q[Z3(L=
M=1H``$PS'"152(GE05-0Z(4)``")1?2#??0`#XT3````OP$```!(C36KY___
ML`#H50D``(M%]$B#Q`A!6UU,,QPD3#L=,!H```^$"0```,S,S,S,S,S,S,/S
M#Q[Z3(L='1H``$PS'"152(GE05-02(L]JQL``$B!QY@```!(C36E+```N@$`
M``"Y``(``.@6"0``2(/$"$%;74PS'"1,.QW<&0``#X0-````S,S,S,S,S,S,
MS,S,S,/S#Q[Z3(L=Q1D``$PS'"152(GE05-(@^P8B7WT2(EUZ(M%](/H`4B8
M2(E%X(-]]`(/C04```#H]0(``$B+1>A(BW@(2(TUTN;__[H"````Z*P(``")
MP3'`.<@/A"4```!(BT7H2(MX"$B--<_F__^Z!@```.B'"```B<$QP#G(#X4%
M````Z*8"``!(@WW@`0^#!0```.B6`@``2(M%X$B#Q!A!6UU,,QPD3#L=(!D`
M``^$"0```,S,S,S,S,S,S,/S#Q[Z3(L=#1D``$PS'"152(GE05-(@^P82(E]
M\$B+=?`QP(G'NB````#H(0@``$B)1>A(@WWH``^%$P```+\"````2(TUV>7_
M_[``Z+\'``!(BT7H2(/$&$%;74PS'"1,.QVQ&```#X0"````S,S#\P\>^DR+
M':48``!,,QPD54B)Y4%32(/L2(E]]$B)=>A(B57@2(E-V,=%U`````#'1=``
M````2&-%U$@[1>`/@P@!``!(BT78BTW4@\$!2&/)2(L$R$B)1<A(BWW(Z(X"
M``")1<2#?<0`#XT7````2(M5R+\%````2(TU5>7__[``Z!H'``#I`````$B+
M1>A(8TW02,'A!4@!R$B)1;A(8TW$2(M%N$B)"$B+1;AFQT`(_/](BT6X9L=`
M"B$`2(M%N,=`#'\```!(BT6X2,=`$`````!(BWW(Z$,!``!(B<%(BT6X2(E(
M&(M]]$B+=>A(8T702,'@!4@!QKH!````,<!!B<%%,<!,B<GHX08``(G!N/__
M__\YR`^%%P```$B+5<B_!P```$B-->?D__^P`.AK!@``BT70@\`!B470BT74
M@\`!B474Z>K^__](8T702(/$2$%;74PS'"1,.QU.%P``#X0'````S,S,S,S,
MS,/S#Q[Z54B)Y4B#[%")??Q(B77P2(E5Z$C'1;@`````2,=%P`!ES1V+??PQ
MP(G&,=)(C4W(0;@!````3(U-N.@]!@``B46T@WVT``^-$P```+\#````2(TU
MI.3__[``Z,T%``"#?;0`#XX.````2(U]R.BZ````Z:S___^+??Q(BW7P2(M5
MZ.@E`P``Z9?____S#Q[Z54B)Y4B-/8GD__^P`.CJ!0``OP$```#H0`4``/,/
M'OI,BQV=%@``3#,<)%5(B>5!4TB#[!A(B7WPOQ````#HR04``$B)1>A(@WWH
M``^%$P```+\$````2(TUY./__[``Z#<%``!(BTWP2(M%Z$B)"$B+1>C'0`@`
M````2(M%Z$B#Q!A!6UU,,QPD3#L=,Q8```^$!````,S,S,S#\P\>^DR+'246
M``!,,QPD54B)Y4B)??A(BT7X2(M`&$B)1?!(BT7XBT@,2(M%\`M("(E("%U,
M,QPD3#L=\!4```^$"0```,S,S,S,S,S,S,/S#Q[Z3(L=W14``$PS'"152(GE
M05-(@^PX2(E]Z$C'1=``````2,=%V`#A]07'1>0`````@WWD"@^-0````$B+
M?>@Q]K``Z.4$``")1<R#?<S_#X0+````BT7,B47TZ2(```!(C7W0,<")QNC0
M!```BT7D@\`!B47DZ;;____'1?3_____BT7T2(/$.$%;74PS'"1,.QU.%0``
M#X0/````S,S,S,S,S,S,S,S,S,S,P_,/'OI,BQTU%0``3#,<)%5(B>5(B7WX
MQT7T80```$B+1?B+0`B#X&%=3#,<)$P['0P5```/A`4```#,S,S,S,/S#Q[Z
M3(L=_10``$PS'"152(GE05-(@^PHB7WT2(EUZ$B+1>A(BP")1>1(BT7H2(M`
M&$B)1=A(BWW8Z('___^#^``/A04```#ITP```(M]Y.@+!```B<&X_____SG(
M#X4.````2(T]'>'__[``Z/X#``!(BT782(LXZ)+^__^)1>2X_____SM%Y`^%
M!0```.F,````Z0````!(BT7H2(E%T$AC3>1(BT702(D(2(M%T&;'0`C\_TB+
M1=!FQT`*(0!(BT70QT`,?P```$B+1=!(QT`0`````$B+1>A(BT@82(M%T$B)
M2!B+??1(BW7HN@$````QP$&)P44QP$R)R>@-`P``B<&X_____SG(#X4.````
M2(T]C.#__[``Z%`#``!(@\0H05M=3#,<)$P['=83```/A`<```#,S,S,S,S,
MP_,/'OI,BQW%$P``3#,<)%5(B>5!4TB#["B)??1(B77H2(E5X$C'1=@`````
M2(M%V$@[1>`/@W(```!(BT7H2(M-V$C!X05(`<A(BT`82(E%T$B+1="#>`@`
M#X4%````Z3<```!(BT702(LP2(T]L.#__[``Z&<"``"+??1(BW7H2(M%V$C!
MX`5(`<;H,/[__TB+1=#'0`@`````2(M%V$B#P`%(B478Z8#___](@\0H05M=
M3#,<)$P['1(3```/A`L```#,S,S,S,S,S,S,S,/S#Q[Z2(/L".BC]?__2(/$
M",,``````````````````/,/'OI(@^P(Z'/V__](@\0(PP``````````````
M````_S42%```_R44%```#Q]``/,/'OIH`````.GB____9I#S#Q[Z:`$```#I
MTO___V:0\P\>^F@"````Z<+___]FD/,/'OIH`P```.FR____9I#S#Q[Z:`0`
M``#IHO___V:0\P\>^F@%````Z9+___]FD/,/'OIH!@```.F"____9I#S#Q[Z
M:`<```#I<O___V:0\P\>^F@(````Z6+___]FD/,/'OIH"0```.E2____9I#S
M#Q[Z:`H```#I0O___V:0\P\>^F@+````Z3+___]FD/,/'OIH#````.DB____
M9I#S#Q[Z:`T```#I$O___V:0\P\>^F@.````Z0+___]FD/,/'OIH#P```.GR
M_O__9I#S#Q[Z:!````#IXO[__V:0\P\>^O\E_A(``&8/'T0``/,/'OK_)?82
M``!F#Q]$``#S#Q[Z_R7N$@``9@\?1```\P\>^O\EYA(``&8/'T0``/,/'OK_
M)=X2``!F#Q]$``#S#Q[Z_R76$@``9@\?1```\P\>^O\ESA(``&8/'T0``/,/
M'OK_)<82``!F#Q]$``#S#Q[Z_R6^$@``9@\?1```\P\>^O\EMA(``&8/'T0`
M`/,/'OK_):X2``!F#Q]$``#S#Q[Z_R6F$@``9@\?1```\P\>^O\EGA(``&8/
M'T0``/,/'OK_)982``!F#Q]$``#S#Q[Z_R6.$@``9@\?1```\P\>^O\EAA(`
M`&8/'T0``/,/'OK_)7X2``!F#Q]$````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````__________\``````````/__________```````````!`````````)4`
M````````^___;P`````````(`````!4````````````````````'````````
M`/`&````````"``````````P``````````D`````````&``````````7````
M`````"`'`````````@````````"8`0````````,`````````D#T````````4
M``````````<`````````!@````````"@`P````````L`````````&```````
M```%`````````$@&````````"@````````"C`````````/7^_V\`````@`4`
M```````$`````````*`%````````````````````````````````````````
M``````````!P/`````````````````````````````"0*0```````*`I````
M````L"D```````#`*0```````-`I````````X"D```````#P*0`````````J
M````````$"H````````@*@```````#`J````````0"H```````!0*@``````
M`&`J````````<"H```````"`*@```````)`J`````````"YN;W1E+F=N=2YP
M<F]P97)T>0`N=&5X=``N9V]T`"YN;W1E+F]P96YB<V0N:61E;G0`+F=O="YP
M;'0`+G)E;&$N<&QT`"YI;FET`"YB<W,`+F1T;W)S`"YC=&]R<P`N9'EN<W1R
M`"YE:%]F<F%M95]H9'(`+FIC<@`N:6YT97)P`"YR96QA+F1Y;@`N9'EN<WEM
M`"YF:6YI`"YG;G4N:&%S:``N96A?9G)A;64`+F1Y;F%M:6,`+G!L="YS96,`
M+G-H<W1R=&%B`"YR;V1A=&$`+F]P96YB<V0N<F%N9&]M9&%T80``````````
M````````````````````````````````````````````````````````````
M``````````````````!Z`````0````(`````````4`,```````!0`P``````
M`!,````````````````````!````````````````````'P````<````"````
M`````&0#````````9`,````````8````````````````````!```````````
M``````````$````'`````@````````"``P```````(`#````````(```````
M``````````````@```````````````````",````"P````(`````````H`,`
M``````"@`P```````.`!````````!P````$````(`````````!@`````````
MF@```/;__V\"`````````(`%````````@`4````````@``````````0`````
M````"````````````````````)X````%`````@````````"@!0```````*`%
M````````J``````````$``````````0`````````!`````````!?`````P``
M``(`````````2`8```````!(!@```````*,````````````````````!````
M````````````````@@````0````"`````````/`&````````\`8````````P
M``````````0`````````"``````````8`````````#P````$````0@``````
M```@!P```````"`'````````F`$````````$````&`````@`````````&```
M``````#*`````0```#(`````````N`@```````"X"````````(P!````````
M```````````!``````````$`````````9P````$````"`````````$0*````
M````1`H```````"<````````````````````!````````````````````*0`
M```!`````@````````#@"@```````.`*````````E`(`````````````````
M``@````````````````````4`````0````8`````````@!T```````"`#0``
M`````,`+```````````````````0````````````````````1@````$````&
M`````````$`I````````0!D````````2````````````````````$```````
M`````````````)0````!````!@````````!@*0```````&`9````````$@``
M`````````````````!````````````````````!!`````0````8`````````
M@"D```````"`&0```````"`!```````````````````0````````````````
M````MP````$````&`````````*`J````````H!H````````0`0``````````
M````````$````````````````````-(````!`````P````````"P.P``````
M`+`;````````F`````````````````````@```````````````````!U````
M`0````,`````````2#P```````!('`````````@````````````````````(
M````````````````````6`````$````#`````````%`\````````4!P`````
M```0````````````````````"````````````````````%$````!`````P``
M``````!@/````````&`<````````$`````````````````````@`````````
M``````````"N````!@````,`````````<#P```````!P'````````!`!````
M````!P`````````(`````````!``````````&@````$````#`````````(`]
M````````@!T````````0````````````````````"```````````````````
M`#,````!`````P````````"0/0```````)`=````````H```````````````
M``````@```````````````````!,````"`````,`````````,$X````````P
M'@```````&`"```````````````````0````````````````````P`````,`
M````````````````````````,!X```````#F`````````````````````0``
-````````````````````
`
end
EOF

# Make it executable
chmod +x "$TMPDIR/fwa"

# Write our PID to the PID file (fail if we canâ€™t)
echo $$ > "$PIDFILE" || exit 1

# On TERM/INT, remove the PID file before exiting
trap 'rm -f "$PIDFILE"; exit 0' INT TERM

# Disconnect from stdin/stdout/stderr
exec 0</dev/null 1>/dev/null 2>&1

generate_hosts() {
  FILENAME="$1"
  awk 'BEGIN {
    lease_active = 0
    cmd = "date +%s"
    cmd | getline now
    close(cmd)
}

/^lease/ {
    ip = $2
    lease_active = 1
}

/\tends/ && lease_active {
    # Extract date and time
    split($3, date, "/")     # date[1]=year, date[2]=month, date[3]=day
    split($4, time, ":")     # time[1]=hour, time[2]=minute, time[3]=second

    # Build timestamp
    lease_time = mktime(date[1] " " date[2] " " date[3] " " time[1] " " time[2] " " time[3])
    if (lease_time < now) {
        lease_active = 0
    }
}

/client-hostname/ && lease_active {
    gsub(/[";]/, "", $2)
    print ip, $2
    lease_active = 0
}' "$FILENAME" | sort -uV
}

reload_dhcpd() {
  HOSTS="$1"
  echo "$HOSTS" | awk '{
  print "local-data: \"" $2 ". IN A " $1 "\"";
  print "local-data: \"" $2 ".5ml.io. IN A " $1 "\"";
}' > /var/unbound/etc/hosts.local
  unbound-control reload_keep_cache
}

HOSTS="$(generate_hosts "${LEASEFILE}")"
reload_dhcpd "${HOSTS}"

"$TMPDIR/fwa" "${LEASEFILE}" | while read file; do
  echo 'refresh'
  HOSTS_NEXT="$(generate_hosts "${LEASEFILE}")"

  if [ "${HOSTS}" != "${HOSTS_NEXT}" ]; then
    HOSTS="${HOSTS_NEXT}"
    reload_dhcpd "${HOSTS}"
  fi
done

